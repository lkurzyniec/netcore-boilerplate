---
name: Auto merge

on:
  workflow_dispatch:
  schedule:
    - cron: "30 2 * * 1" # 02:30 on Monday

permissions:
  pull-requests: write
  contents: write

jobs:
  auto-merge:
    name: Auto merge
    runs-on: ubuntu-latest

    steps:
      - name: Auto merge
        env:
          SLEEP_TIME: ${{ vars.AUTO_MERGE_SLEEP_TIME }}
        run: |
          counter=0
          gh pr list --label "auto-merged" --json number,title | jq -c '.[]' | while read pr; do
            number=$(echo $pr | jq -r '.number')
            title=$(echo $pr | jq -r '.title')

            echo "PR #$number: $title"
            gh pr checkout $number
            git rebase main
            git push --force-with-lease
            echo "Rebase completed!"

            echo "Time to a nap..."
            sleep "${SLEEP_TIME}m"
            echo "Break finished!"
            ((counter++))
          done

          echo "### Processed ${COUNTER} PRs :robot:" >> $GITHUB_STEP_SUMMARY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
